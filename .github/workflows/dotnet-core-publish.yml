name: .NET Core Publish

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set env
      run: echo ::set-env name=RELEASE_VERSION::${GITHUB_REF#refs/*/}
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.301
    - name: Install dependencies
      working-directory: src
      run: dotnet restore
    - name: Build
      run: dotnet build --configuration Release --no-restore
      working-directory: src
    - name: Test
      working-directory: src
      run: dotnet test --no-restore --verbosity normal
    - name: Pack NuGet
      working-directory: src
      run: dotnet pack --configuration Release /p:Version=${{ env.RELEASE_VERSION }}
    - name: Push NuGet
      working-directory: src
      run: dotnet nuget push -k ${{secrets.NUGET_API_KEY}} -s https://api.nuget.org/v3/index.json VCEL.Core/bin/Release/VCEL.Core.${{ env.RELEASE_VERSION }}.nupkg
    - name: Push GitHub Packages
      working-directory: src
      run: dotnet nuget push -k ${{secrets.GITHUB_TOKEN}} -s https://nuget.pkg.github.com/EclipseTrading/index.json VCEL.Core/bin/Release/VCEL.Core.${{ env.RELEASE_VERSION }}.nupkg
